<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- ... 原有头部内容 ... -->
</head>
<body>
    <!-- ... 原有HTML内容 ... -->

    <script>
        class ReactiveChatClient {
            constructor() {
                // ... 原有属性 ...
                this.fileUpload = document.getElementById('file-upload');
                this.imagePreview = document.getElementById('image-preview');
                this.clearImageBtn = document.getElementById('clear-image-btn');
                
                // 添加用于存储图片Base64数据的属性
                this.imageBase64Data = null;
                
                // ... 原有初始化 ...
            }

            handleImageUpload(event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.imagePreview.src = e.target.result;
                        this.imagePreview.style.display = 'block';
                        // 保存图片的Base64数据
                        this.imageBase64Data = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    this.clearImage();
                }
            }

            clearImage() {
                this.fileUpload.value = '';
                this.imagePreview.style.display = 'none';
                this.imagePreview.src = '';
                this.imageBase64Data = null;
            }

            sendMessage() {
                const message = this.questionInput.value.trim();
                const reset = this.resetCheckbox.checked;
                if (!message || this.isStreaming) return;

                // 显示用户消息
                this.displayUserMessage(message);
                this.questionInput.value = '';

                // 显示机器人正在输入指示器
                const indicatorId = this.showTypingIndicator();

                // 修改为POST请求URL
                const deepseekurl = `/demoproject/reactor/deepseekBackuppressSession.api`;
                const vlurl = `/demoproject/reactor/qwenvl.api`;
                
                let url;
                const selectedModel = this.modelSelect.value;
                if (selectedModel === 'deepseek') {
                    url = deepseekurl;
                } else if (selectedModel === 'qwenvlplus') {
                    url = vlurl;
                }

                // 创建AbortController用于取消请求
                this.abortController = new AbortController();
                this.isStreaming = true;

                // 构建请求体
                const requestBody = {
                    message: message,
                    reset: reset
                };

                // 根据模型类型添加相应的图片参数
                if (selectedModel === 'qwenvlplus') {
                    // 如果是URL模式且有输入URL，则使用URL
                    if (this.imageUrlInput.value.trim()) {
                        requestBody.imageUrl = this.imageUrlInput.value.trim();
                    }
                    // 如果是上传图片模式且有上传图片，则使用base64数据
                    else if (this.imageBase64Data) {
                        requestBody.imageBase64 = this.imageBase64Data;
                    }
                }

                // 使用fetch API进行POST流式请求
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody),
                    signal: this.abortController.signal
                })
                // ... 后续代码保持不变 ...
            }

            displayUserMessage(content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user-message';

                // 添加文字内容
                if (content) {
                    const textDiv = document.createElement('div');
                    textDiv.textContent = content;
                    messageDiv.appendChild(textDiv);
                }

                // 如果有预览图片，则添加图片
                if (this.imagePreview.style.display !== 'none') {
                    const img = document.createElement('img');
                    img.src = this.imagePreview.src;
                    img.alt = "用户上传的图片";
                    messageDiv.appendChild(img);
                }

                this.chatContainer.appendChild(messageDiv);
                this.scrollToBottom();
                
                // 注意：不清除图片在这里，而是在请求发送完成后清除
            }

            // ... 其他方法保持不变 ...
        }

        // ... 原有初始化代码 ...
    </script>
</body>
</html>
