<!-- 在 #model-select 的 option 列表中添加 -->
<option type="VIDEO" value="qwen-video">wan2.5-t2v-preview（百炼视频生成）</option>
<!-- 视频任务查询区域 -->
<div id="video-task-container" style="display: none; margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <input type="text" id="task-id-input" placeholder="请输入视频生成任务ID..." style="flex: 1; padding: 5px;" />
        <button id="query-task-btn">查询任务状态</button>
    </div>
    <div id="task-result-container" style="margin-top: 10px;"></div>
</div>

/**
 * 视频生成服务
 * http://127.0.0.1/demoproject/reactor/genVideoByqwenwan.api
 * @param questions
 * @return
 * @throws InterruptedException
 */
public @ResponseBody Map genVideoByqwenwan(@RequestBody Map<String,Object> questions) throws InterruptedException {
    String message = questions != null ? (String)questions.get("message") : null;
    if(SimpleStringUtil.isEmpty(message)) {
        message = "一幅史诗级可爱的场景。一只小巧可爱的卡通小猫将军，身穿细节精致的金色盔甲，头戴一个稍大的头盔，勇敢地站在悬崖上。";
    }

    Map<String, Object> requestMap = new HashMap<>();
    requestMap.put("model", "wan2.5-t2v-preview");

    Map<String,Object> input = new LinkedHashMap();
    input.put("prompt", message);
    input.put("language_type", "Chinese");
    requestMap.put("input", input);

    Map<String,Object> parameters = new LinkedHashMap();
    parameters.put("size", "832*480");
    parameters.put("prompt_extend", true);
    parameters.put("duration", 10);
    parameters.put("audio", true);
    requestMap.put("parameters", parameters);

    Map header = new LinkedHashMap();
    header.put("X-DashScope-Async", "enable");
    
    // 提交视频生成任务并获取任务ID
    Map taskInfo = HttpRequestProxy.sendJsonBody("qwenvlplus", requestMap, 
        "/api/v1/services/aigc/video-generation/video-synthesis", Map.class);

    return taskInfo;
}

/**
 * 查询视频生成任务执行结果服务
 * http://127.0.0.1/demoproject/reactor/getVideoTaskResult.api
 * @param questions
 * @return
 * @throws InterruptedException
 */
public @ResponseBody Map getVideoTaskResult(@RequestBody Map<String,Object> questions) throws InterruptedException {
    Map<String, Object> result = new HashMap<>();
    String taskId = questions != null ? (String)questions.get("taskId") : null;
    
    if(SimpleStringUtil.isEmpty(taskId)) {
        result.put("error", "taskId为空");
        return result;
    }

    String requestUrl = "/api/v1/tasks/" + taskId;
    Map taskInfo = HttpRequestProxy.httpGetforObject("qwenvlplus", requestUrl, Map.class);
    return taskInfo;
}
// 在 constructor 中添加新属性
this.videoTaskContainer = document.getElementById('video-task-container');
this.taskIdInput = document.getElementById('task-id-input');
this.queryTaskBtn = document.getElementById('query-task-btn');
this.taskResultContainer = document.getElementById('task-result-container');

// 在 initEventListeners 方法中添加事件监听
this.modelSelect.addEventListener('change', () => this.toggleVideoInput());
this.queryTaskBtn.addEventListener('click', () => this.queryVideoTask());

// 在 toggleAudioInput 方法后添加
toggleVideoInput() {
    this.modelType = this.modelSelect.options[this.modelSelect.selectedIndex].getAttribute('type');
    
    // 隐藏所有特殊输入区域
    this.uploadContainer.style.display = 'none';
    this.audioInputContainer.style.display = 'none';
    this.videoTaskContainer.style.display = 'none';
    
    // 根据模型类型显示对应区域
    if (this.modelType === 'VL') {
        this.uploadContainer.style.display = 'block';
        this.questionInput.style.flex = 'unset';
        this.questionInput.style.width = '200px';
    } else if (this.modelType === 'AUDIO') {
        this.audioInputContainer.style.display = 'flex';
        this.questionInput.style.flex = 'unset';
        this.questionInput.style.width = '200px';
    } else if (this.modelType === 'VIDEO') {
        this.videoTaskContainer.style.display = 'block';
        this.questionInput.style.flex = 'unset';
        this.questionInput.style.width = '200px';
    } else {
        this.questionInput.style.flex = '1';
        this.questionInput.style.width = '';
        this.imageUrlInput.value = '';
    }
}

// 添加视频任务查询方法
queryVideoTask() {
    const taskId = this.taskIdInput.value.trim();
    if (!taskId) {
        alert('请输入任务ID');
        return;
    }

    const url = 'reactor/getVideoTaskResult.api';
    const requestBody = { taskId: taskId };

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
        this.displayTaskResult(data);
    })
    .catch(error => {
        console.error('查询任务失败:', error);
        this.displayErrorMessage('查询任务失败: ' + error.message);
    });
}

// 显示任务查询结果
displayTaskResult(data) {
    this.taskResultContainer.innerHTML = '';
    
    if (data.error) {
        this.taskResultContainer.innerHTML = `<div style="color: red;">错误: ${data.error}</div>`;
        return;
    }

    const status = data.output && data.output.task_status ? data.output.task_status : '未知';
    const resultDiv = document.createElement('div');
    resultDiv.className = 'task-result';
    
    let content = `<div><strong>任务ID:</strong> ${data.request_id || 'N/A'}</div>`;
    content += `<div><strong>任务状态:</strong> ${status}</div>`;
    
    if (data.output && data.output.video_url) {
        content += `
            <div style="margin-top: 10px;">
                <strong>生成的视频:</strong><br/>
                <video controls style="max-width: 100%; height: auto; margin-top: 5px;">
                    <source src="${data.output.video_url}" type="video/mp4">
                    您的浏览器不支持视频播放。
                </video>
                <div style="margin-top: 5px;">
                    <a href="${data.output.video_url}" target="_blank" download>下载视频</a>
                </div>
            </div>
        `;
    } else if (data.output && data.output.message) {
        content += `<div><strong>任务信息:</strong> ${data.output.message}</div>`;
    }
    
    resultDiv.innerHTML = content;
    this.taskResultContainer.appendChild(resultDiv);
}

// 修改 sendMessage 方法处理视频生成请求
// 在 switch 语句中添加 VIDEO 模型处理
// case 'VIDEO':
//     url = `reactor/genVideoByqwenwan.api`;
//     break;

// 在 sendMessage 方法的 fetch.then 部分添加对视频生成响应的处理
// 特殊处理VIDEO模型的响应
else if (this.modelType === 'VIDEO') {
    return response.json().then(data => {
        this.isStreaming = false;
        let botMessageElement = this.createBotMessageElement();

        // 显示任务信息
        if (data && data.request_id) {
            const taskInfo = document.createElement('div');
            taskInfo.innerHTML = `
                <div><strong>视频生成任务已提交</strong></div>
                <div><strong>任务ID:</strong> ${data.request_id}</div>
                <div><strong>状态:</strong> ${data.output ? data.output.task_status : '提交中'}</div>
                ${data.output && data.output.message ? `<div><strong>信息:</strong> ${data.output.message}</div>` : ''}
                <div style="margin-top: 10px;">
                    <button onclick="document.getElementById('task-id-input').value='${data.request_id}';document.getElementById('query-task-btn').click()">查询任务状态</button>
                </div>
            `;
            botMessageElement.appendChild(taskInfo);
        } else {
            botMessageElement.textContent = '视频生成任务提交失败';
        }

        this.scrollToBottom();
    });
}

